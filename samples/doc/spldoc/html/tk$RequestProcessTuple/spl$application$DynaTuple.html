<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en-us" lang="en-us">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="copyright" content="(C) Copyright 2005"/>
<meta name="DC.rights.owner" content="(C) Copyright 2005"/>
<meta name="DC.Type" content="reference"/>
<meta name="DC.Title" content="SPL File DynaTuple.spl"/>
<meta name="DC.Format" content="XHTML"/>
<meta name="DC.Identifier" content="spldoc_compilationunit"/>
<link rel="stylesheet" type="text/css" href="../../html/commonltr.css"/>
<link rel="stylesheet" type="text/css" href="../../html/spldoc.css"/>
<title>SPL File DynaTuple.spl</title>
</head>
<body id="spldoc_compilationunit">


<h1 class="title topictitle1">SPL File <tt class="ph tt">DynaTuple.spl</tt></h1>

<div class="body refbody">
<div class="section">
<p class="p">
<a class="xref" href="../toolkits/toolkits.html">IBMStreams streamsx.inetserver Toolkit</a> &gt; <a class="xref" href="tk$RequestProcessTuple.html">RequestProcessTuple 1.0.0</a> &gt; <a class="xref" href="ns$application.html">application</a> &gt; DynaTuple.spl</p>

</div>

<div class="section"><h2 class="title sectiontitle splhead-1">Content</h2>
  
  <dl class="dl">
    <dt class="dt dlterm"/>
<dd class="dd"/>

    
      <dt class="dt dlterm splhead-2">Operators</dt>

      <dd class="dd">
<ul class="sl simple">
<li class="sli"><strong class="ph b"><a class="xref" href="spl$application$DynaTuple.html#spldoc_compilationunit__composite_operator__DynTuple">DynTuple</a></strong>: This is an example of using the HTTPRequestProcess() operator to put up a form,  get form input and generate a response.
</li>

</ul>

      </dd>

    
  </dl>

</div>

<div class="section"><h2 class="title sectiontitle splhead-1">Composites</h2>
  
</div>

<div class="section" id="spldoc_compilationunit__composite_operator__DynTuple"><h2 class="title sectiontitle splpart">composite DynTuple</h2>
  
</div>

<div class="section splgraph">
  <embed class="image" src="../../image/tk$RequestProcessTuple/op$application$DynTuple.svg" width="640" height="130"/>
</div>

<div class="section">

<p class="p">This is an example of using the HTTPRequestProcess() operator to put up a form,  get form input and generate a response. This uses the Tuple aspect of the operator, the RequestProcessJson example does this same process with the Json aspect. 
</p>

<div class="p">Description: 
<ul class="ul">
<li class="li"> Using th context put up the index.html page in /opt/html, which includes a form.</li>

<li class="li"> The forms action (/livepage/HttpTuple/ports/analyze/0/login) post to the operator.</li>

<li class="li"> The HTTPTupleProcess operator outputs the request, note the use of pathInfo to route the request.</li>

<li class="li"> On completion of the processing, the response is input to the originating HTTPTupleProcess operator. </li>

</ul>

</div>

<div class="p">The goal:
<ul class="ul">
<li class="li"> Demonstrate the processing of forms.</li>

<li class="li"> Reinterate how important it is NOT to mess with the id. </li>

</ul>

</div>

<div class="p">Procedure:
<ul class="ul">
<li class="li"> build the sample - execute 'make'</li>

<li class="li"> submit the sample to your streams instance</li>

<li class="li"> open the browser and point tu url http://localhost:8080/livepage</li>

<li class="li"> fill in the form and submit  </li>

</ul>

</div>

</div>

<div class="section">
</div>

<div class="section">
</div>

<div class="section">
</div>

<div class="section"><h2 class="title sectiontitle splhead-2">SPL Source Code</h2>
  
</div>


<div class="section">
   <pre class="pre codeblock">

 public composite DynTuple {
 
 	graph
 		
 		/*
 		 * Receive a HTTP request and forward the content into the RequestStrream 
 		 * Receive the answer from Streams in ResponseStream1 build the HTTP response
 		 */
 		(stream&lt;HTTPRequest&gt; RequestStream as O) as HttpTuple = HTTPRequestProcess(ResponseStream1) {
 			param
 				context : "livepage" ;
 				contextResourceBase : getThisToolkitDir() + "/opt/html" ;
 				port : 8080 ;
 		}
 
 		/*
 		 * Print out the received request parameters
 		 */
 		stream&lt;HTTPRequest&gt; RequestStream1 as O = Custom(RequestStream as I) {
 			logic
 				onTuple I: {
 					printStringLn("REQUEST:" + (rstring)I);
 					submit(I, O);
 				}
 				onPunct I: printStringLn("REQUEST:" + (rstring)currentPunct());
 		}
 		
 		/*
 		 * Filter the requests 
 		 * /login request ? drop on floor if not. Real code with have multiple branches.
 		 */
 		stream&lt;HTTPRequest&gt; LoginStream as O = Functor(RequestStream1 as I) {
 			param
 				filter : I.pathInfo == "/login" ;
 		}
 
 		/*
 		 * Parse form parameters
 		 */
 		stream&lt;int64 key, map&lt;rstring, rstring&gt; formdata, rstring error&gt; FormStream as O = Custom(LoginStream as I) {
 			logic
 				onTuple I : {
 					//transfer the tracking key
 					mutable O otuple = {};
 					otuple.key = I.key;
 					//get the form data
 					otuple.error = "";
 					mutable list&lt;rstring&gt; dict = [];
 					dict = tokenize(I.request, "&amp;", true);
 					if(size(dict) &gt; 0) {
 						for(rstring entry in dict) {
 							println("entry:" + entry);
 							list&lt;rstring&gt; keyval = tokenize(entry, "=", true) ;
 							if(size(keyval) &gt; 1) {
 								insertM(otuple.formdata, keyval[0], keyval[1]);
 							} else if(size(keyval) == 1) {
 								insertM(otuple.formdata, keyval[0], "");
 							} else {
 								otuple.error = "ERROR-nameValueParse";
 							}
 						}
 					} else {
 						otuple.error = "ERROR-noFormData";
 					}
 					println(otuple);
 					submit(otuple, O) ;
 				}
 		}
 
 		/*
 		 * Build the response: Accept request with any password. Emulate an error if the password is empty
 		 * This builds the HTML that is to returned to the browser. 
 		 * The page will invoke the template normal.hbs or junk.hbspassed, the variables
 		 * that the template file will be using variables that are in the I.formdata (map&lt;rstring, rstring&gt;).
 		 */
 		stream&lt;HTTPRequest&gt; ResponseStream as O = Custom(FormStream as I) {
 			logic
 				state : {
 					rstring preHtml = '&lt;!DOCTYPE html&gt; &lt;html lang="en"&gt;&lt;title&gt;Demonstration&lt;/title&gt;';
 					rstring junkHtml = '
 &lt;body&gt;
   &lt;meta charset=\'utf-8\'&gt;
   &lt;div&gt;
     &lt;h1&gt;Pitiful password dude.&lt;/h1&gt;
     &lt;p&gt;Here we are in the Status code 401 case indicating that the request requires authentication.&lt;/p&gt;
     &lt;h2&gt;Yo! %name% ! &lt;/h2&gt;
     &lt;p&gt;What is with the password, you can do better than that. &lt;/p&gt;
 
     &lt;table border="2"&gt;
         &lt;tr&gt;&lt;th&gt;NAME&lt;/th&gt;&lt;th&gt;PROFESSION&lt;/th&gt;&lt;/tr&gt;
         &lt;tr&gt;&lt;td&gt;%name%&lt;/td&gt;&lt;td&gt;%profession%&lt;/td&gt;&lt;/tr&gt;
     &lt;/table&gt;
         I am a %profession%.
   &lt;/div&gt;
 &lt;/body&gt;
 &lt;/html&gt;';
 					rstring normalHtml = '
 &lt;body&gt;
   &lt;meta charset=\'utf-8\'&gt;
   &lt;div&gt;
     &lt;h1&gt;Demo Nonsense Text&lt;/h1&gt;
     &lt;p&gt;Here we are in the Status code 200 case indicating the request succeeded normally.&lt;/p&gt;
     &lt;h2&gt;My name is %name%. &lt;/h2&gt;
     &lt;p&gt;To be, or not to be, that is the question:&lt;/p&gt;
     &lt;p&gt;Whether \'tis nobler in the mind to suffer&lt;/p&gt;
     &lt;p&gt;The slings and arrows of outrageous fortune,&lt;/p&gt;
     &lt;p&gt;Or to take Arms against a Sea of troubles,&lt;/p&gt;
     &lt;p&gt;and opposing them by becoming a %profession%&lt;/p&gt;
     &lt;p&gt;and fighting the good fight.&lt;/p&gt;
 
     &lt;table border="2"&gt;
         &lt;tr&gt;&lt;th&gt;NAME&lt;/th&gt;&lt;th&gt;PROFESSION&lt;/th&gt;&lt;/tr&gt;
         &lt;tr&gt;&lt;td&gt;%name%&lt;/td&gt;&lt;td&gt;%profession%&lt;/td&gt;&lt;/tr&gt;
     &lt;/table&gt;
         I am a %profession%.
   &lt;/div&gt;
 &lt;/body&gt;
 &lt;/html&gt;';
 				}
 				onTuple I : {
 					//transfer the tracking key
 					mutable O otuple = {};
 					otuple.key = I.key;
 					if (I.error == "") {
 						if (has(I.formdata, "name") &amp;&amp; has(I.formdata, "password") &amp;&amp; has(I.formdata, "profession")) {
 							if (I.formdata["name"] == "") {
 								otuple.status = 400; //Status code (400) indicating the request sent by the client was syntactically incorrect.
 								otuple.response = "ERROR-nameRequired";
 							} else {
 								if (I.formdata["password"] == "") {
 									otuple.status = 401; //Status code (401) indicating that the request requires HTTP authentication.
 									rstring html1 = regexReplace(junkHtml, "%name%", I.formdata["name"], true);
 									rstring html2 = regexReplace(html1, "%profession%", I.formdata["profession"], true);
 									otuple.response = preHtml + html2;
 								} else {
 									otuple.status = 200; //Status code (200) indicating the request succeeded normally.
 									rstring html1 = regexReplace(normalHtml, "%name%", I.formdata["name"], true);
 									rstring html2 = regexReplace(html1, "%profession%", I.formdata["profession"], true);
 									otuple.response = preHtml + html2;
 								}
 							}
 						} else {
 							otuple.status = 400; //Status code (400) indicating the request sent by the client was syntactically incorrect.
 							otuple.response = "ERROR-notRequiredParams";
 						}
 					} else {
 						otuple.status = 400; //Status code (400) indicating the request sent by the client was syntactically incorrect.
 						otuple.response = I.error;
 					}
 					submit(otuple, O);
 				}
 		}
 
 		/*
 		 * Print the response stream
 		 */
 		stream&lt;HTTPRequest&gt; ResponseStream1 as O = Custom(ResponseStream as I) {
 			logic
 				onTuple I: {
 					printStringLn("RESPONSE:" + (rstring)I);
 					submit(I, O);
 				}
 				onPunct I: printStringLn("RESPONSE:" + (rstring)currentPunct());
 		}
 
 	config
 		restartable: false;
 }

   </pre>

</div>

</div>


</body>
</html>